/**
  ******************************************************************************
  * @file    main.c
  * @author  fire
  * @version V1.0
  * @date    2013-xx-xx
  * @brief   rtc 测试，显示时间格式为: xx:xx:xx
  ******************************************************************************
  * @attention
  *
  * 实验平台:野火 F103-指南者 STM32 开发板 
  * 论坛    :http://www.firebbs.cn
  * 淘宝    :https://fire-stm32.taobao.com
  *
  ******************************************************************************
  */

#include "stm32f10x.h"
#include "./usart/bsp_usart.h"
#include "./rtc/bsp_rtc.h"
#include "./lcd/bsp_ili9341_lcd.h"
#include "./key/bsp_key.h"
#include "./beep/bsp_beep.h"
#include "./Led/bsp_led.h"

// N = 2^32/365/24/60/60 = 136 年

/*时间结构体，默认时间2000-01-01 00:00:00*/
struct rtc_time systmtime =
	{
		0, 0, 0, 1, 1, 2000, 0};

/*时间结构体，闹钟时间2000-01-01 00:00:08*/
struct rtc_time clocktime =
	{
		8, 0, 0, 1, 1, 2000, 0};

extern __IO uint32_t TimeDisplay;
extern __IO uint32_t TimeAlarm;

//【*】注意事项：
//在bsp_rtc.h文件中：

//1.可设置宏USE_LCD_DISPLAY控制是否使用LCD显示
//2.可设置宏RTC_CLOCK_SOURCE_LSI和RTC_CLOCK_SOURCE_LSE控制使用LSE晶振还是LSI晶振

//3.STM32的LSE晶振要求非常严格，同样的电路、板子批量产品时总有些会出现问题。
//  本实验中默认使用LSI晶振。
//
//4.！！！若希望RTC在主电源掉电后仍然运行，需要给开发板的电池槽安装钮扣电池，
//  ！！！且改成使用外部晶振模式RTC_CLOCK_SOURCE_LSE
//  钮扣电池型号：CR1220
/**
  * @brief  主函数
  * @param  无  
  * @retval 无
  */

static void SYSCLKConfig_STOP(void)
{
  /* After wake-up from STOP reconfigure the system clock */
  /* 使能 HSE */
  RCC_HSEConfig(RCC_HSE_ON);
  
  /* 等待 HSE 准备就绪 */
  while (RCC_GetFlagStatus(RCC_FLAG_HSERDY) == RESET)
  {
  }
  
  /* 使能 PLL */ 
  RCC_PLLCmd(ENABLE);
  
  /* 等待 PLL 准备就绪 */
  while (RCC_GetFlagStatus(RCC_FLAG_PLLRDY) == RESET)
  {
  }
  
  /* 选择PLL作为系统时钟源 */
  RCC_SYSCLKConfig(RCC_SYSCLKSource_PLLCLK);
  
  /* 等待PLL被选择为系统时钟源 */
  while (RCC_GetSYSCLKSource() != 0x08)
  {
  }
}

int main()
{
	int i = 0;

	USART_Config();
	LED_GPIO_Config();
	Key_GPIO_Config();

	BEEP_GPIO_Config();

	RTC_NVIC_Config();
	RTC_Configuration();
	/* 配置RTC秒中断优先级 */
	
	//RTC_CheckAndConfig(&systmtime);


	while (1)
	{
		
		if(TimeAlarm)
		{
			LED_RED;

			while(1)
			{
				int j = 300;
				while(j--)
				{
					BEEP(ON);
					for(i = 0; i < 0xf; i++);
					BEEP(OFF);
					for(i = 0; i < 0xaff; i++);
					if (Key_Scan(KEY2_GPIO_PORT, KEY2_GPIO_PIN) == KEY_ON)
					{
						BEEP(OFF);
						TimeAlarm = 0;
						
						break;
					}
				}
				if(!TimeAlarm)
					break;
				for(i = 0; i < 0x3ffff; i++);
			}	
		}

		LED_YELLOW;
		while(Key_Scan(KEY1_GPIO_PORT, KEY1_GPIO_PIN) == KEY_OFF);
		LED_GREEN;


		RTC_SetAlarm(RTC_GetCounter() + 3600);
		RTC_WaitForLastTask();

		LED1_OFF;
		LED2_OFF;
		LED3_OFF;
		PWR_EnterSTOPMode(PWR_Regulator_LowPower,PWR_STOPEntry_WFI);
	
		
	}
}

/***********************************END OF FILE*********************************/
